<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace用于绑定Dao接口 -->
<mapper namespace="com.education.hjj.bz.mapper.StudentDemandMapper">

	<!-- 用用查询映射结果 -->
	<resultMap id="studentDemandsResultMap" type="com.education.hjj.bz.entity.vo.StudentDemandVo" >
		<!-- column代表数据库列名，property代表实体类属性名 -->
		<result column="sid" property="sid"/>
		<result column="student_id" property="studentId"/>
		<result column="student_name" property="studentName"/>
		<result column="demand_grade" property="demandGrade"/>
		<result column="subject_id" property="subjectId"/>
		<result column="order_start" property="orderStart"/>
		<result column="week_num" property="weekNum"/>
		<result column="class_num" property="classNum"/>
		<result column="time_range" property="timeRange"/>
		<result column="order_money" property="orderMoney"/>
		<result column="demand_desc" property="demandDesc"/>
		<result column="demand_address" property="demandAddress"/>
		<result column="demand_grade" property="demandGrade"/>
		<result column="status" property="status"/>
		<result column="create_time" property="createTime"/>
		<result column="create_user" property="createUser"/>
		<result column="update_time" property="updateTime"/>
		<result column="update_user" property="updateUser"/>
		<result column="current_week_day" property="currentWeekDay"/>

		<result column="demand_type" property="demandType"/>
		<result column="parameter_id" property="parameterId"/>
		<result column="demand_signUp_num" property="demandSignUpNum"/>
		<result column="teach_grade_name" property="teachGradeName"/>
		<result column="teach_branch_name" property="teachBranchName"/>
		<result column="order_teach_time" property="orderTeachTime"/>
		<result column="demandSignStatus" property="demandSignStatus"/>
	</resultMap>
	
	
    <select id="querystudentDemands"  resultMap="studentDemandsResultMap" parameterType="com.education.hjj.bz.entity.StudentDemandPo">    
        select
        	sd.*
		from
			student_demand sd
		where
			1=1
		<if test='sid != null and sid != ""'>
            AND sd.sid = #{sid}
        </if>
        <if test='demandGrade != null and demandGrade != ""'>
            AND sd.demand_grade = #{demandGrade}
        </if> 
        <if test='demandBranch != null and demandBranch != ""'>
            AND sd.demand_branch = #{demandBranch}
        </if> 
        <if test='studentArea != null and studentArea != ""'>
            AND sd.student_area = #{studentArea}
        </if> 

        order by 
        	sd.create_time desc
        <if test="offset != null">
            <![CDATA[
                limit #{pageSize} offset #{offset}
            ]]>
        </if>
    </select>

	<select id="findMaxSid" resultType="java.lang.Long">
		SELECT MAX(sid)
		FROM student_demand
	</select>
	<select id="listDemandAndTeacher" parameterType="com.education.hjj.bz.formBean.StudentDemandConnectForm" resultMap="studentDemandsResultMap">
		SELECT
			sd.demand_type
			,sdc.teacher_id
		FROM student_demand sd
		LEFT join student_demand_connect sdc
		ON sd.sid = sdc.demand_id
		WHERE sdc.delete_status = 0
		AND sd.sid = #{demandId}
	</select>

	<select id="listDemand" parameterType="com.education.hjj.bz.formBean.StudentDemandConnectForm" resultMap="studentDemandsResultMap">
		select
		   sd.sid,
		   sd.create_time,
		   st.student_name,
		   sd.time_range,
		   sd.class_num,
		   sd.demand_desc,
		   sd.demand_grade,
		   sd.subject_id,
		   sd.status
		from student_demand sd
		inner join student st
		on sd.student_id = st.sid
		WHERE st.delete_status = 0
		AND st.parent_phone_num = #{parentPhoneNum}
		order by
			sd.create_time desc
		<if test="offset != null">
			<![CDATA[
                limit #{pageSize} offset #{offset}
            ]]>
		</if>
	</select>

	<update id="openDemand" parameterType="com.education.hjj.bz.formBean.StudentDemandConnectForm">
	<selectKey resultType="java.lang.Long" keyProperty="sid" >
		SELECT @@IDENTITY AS sid
	</selectKey>
		UPDATE student_demand
		SET demand_type = 2,
			update_time = #{updateTime}
		WHERE sid = #{demandId}
	</update>


    <insert id="addStudentDemandByTeacher" parameterType="com.education.hjj.bz.formBean.StudentDemandForm" >

		<selectKey resultType="long" keyProperty="sid" >
			/*FORCE_MASTER*/ SELECT @@IDENTITY AS sid
		</selectKey>
        INSERT INTO student_demand(
			student_id,
			demand_address,
			demand_grade,
			subject_id,
			order_start,
        	week_num,
        	class_num,
        	time_range,
        	order_type,
        	order_money,
        	demand_desc,
			demand_type,
			parameter_id,
        	status,
        	create_time,
        	create_user,
        	update_time,
        	update_user
        	)
        VALUES (
        	#{studentId},
        	#{demandAddress},
        	#{demandGrade},
        	#{subjectId},
        	#{orderStart},
        	#{weekNum},
        	#{classNum},
        	#{timeRange},
        	#{orderType},
        	#{orderMoney},
        	#{demandDesc},
        	#{demandType},
        	#{parameterId},
        	#{status},
        	#{createTime},
        	#{createUser},
        	#{updateTime},
        	#{updateUser}
        )
    </insert>

	<!-- 教员首页查询所有的需求订单 -->
	<select id="queryAllStudentDemandList" parameterType="com.education.hjj.bz.formBean.StudentDemandForm" resultMap="studentDemandsResultMap">
    	SELECT
			sd.sid,
			sd.demand_address,
			tg.teach_grade_name,
			tb.teach_branch_name,
			sd.class_num,
			sd.time_range,
			sd.demand_desc,
			date_format(sd.create_time, '%Y-%m-%d') as create_time,
			demand_signUp_num
		FROM
			student_demand sd
		LEFT JOIN
			teach_grade tg
		ON	
			sd.demand_grade = tg.teach_grade_id 
		LEFT JOIN
			teach_branch tb
		ON
			sd.subject_id = tb.teach_branch_id
		WHERE
			1=1
		<if test="demandGrade != null">
			AND sd.demand_grade= #{demandGrade}
     	</if>
     	<if test="subjectId != null">
			AND sd.subject_id= #{subjectId}
     	</if>
     	
     		
     	<if test="createTime != null">
			order by create_time desc
     	</if>
    </select>
    
    <!-- 教员首页查询所有的需求订单10条 -->
	<select id="queryAllStudentDemandListBy10" parameterType="com.education.hjj.bz.formBean.StudentDemandForm" resultMap="studentDemandsResultMap">
    	SELECT
			sd.sid,
			sd.demand_address,
			tg.teach_grade_name,
			tb.teach_branch_name,
			sd.class_num,
			sd.time_range,
			sd.demand_desc,
			date_format(sd.create_time, '%Y-%m-%d') as create_time,
			demand_signUp_num
		FROM
			student_demand sd
		LEFT JOIN
			teach_grade tg
		ON	
			sd.demand_grade = tg.teach_grade_id 
		LEFT JOIN
			teach_branch tb
		ON
			sd.subject_id = tb.teach_branch_id
		WHERE
			1=1
     		
		order by create_time desc
		
		limit 10
    </select>

    <!-- 查询需求订单详情 -->
    <select id="queryStudentDemandDetailBySid" parameterType="java.lang.Integer" resultMap="studentDemandsResultMap">
    	SELECT
			sd.sid,
			sd.demand_address,
			tg.teach_grade_name,
			tb.teach_branch_name,
			sd.class_num,
			sd.time_range,
			sd.demand_desc,
			date_format(sd.create_time, '%Y-%m-%d') as create_time,
			demand_signUp_num,
			current_week_day
		FROM
			student_demand sd
		LEFT JOIN
			teach_grade tg
		ON	
			sd.demand_grade = tg.teach_grade_id 
		LEFT JOIN
			teach_branch tb
		ON
			sd.subject_id = tb.teach_branch_id
		WHERE
			1=1
		and
			sd.sid = #{sid}
    </select>
    
    <!-- 新的试讲订单,还没确定试讲时间 -->
    <select id="queryNewTrialOrderList" parameterType="java.lang.Integer" resultMap="studentDemandsResultMap">
    	SELECT
			sd.sid,
			tg.teach_grade_name,
			tb.teach_branch_name,
			date_format(sd.create_time, '%Y-%m-%d %T') as create_time,
			sdc.status as demandSignStatus
		FROM
			student_demand_connect sdc
		LEFT JOIN
			student_demand sd
		ON
			sdc.demand_id = sd.sid
		LEFT JOIN
			teach_grade tg
		ON
			sd.demand_grade = tg.teach_grade_id
		LEFT JOIN
			teach_branch tb
		ON
			sd.subject_id = tb.teach_branch_id
		WHERE
			sdc.`status` = 1
		AND
			sdc.teacher_id = #{teacherId}
		ORDER BY
			sd.create_time desc
    </select>
    
    <!-- 适合我的家教需求订单列表 -->
    <select id="queryFitTeacherOrderList" parameterType="java.lang.Integer" resultMap="studentDemandsResultMap">
    	SELECT
			sd.sid,
			sd.demand_address,
			tg.teach_grade_name,
			tb.teach_branch_name,
			sd.class_num,
			sd.time_range,
			sd.demand_desc,
			date_format(sd.create_time, '%Y-%m-%d') as create_time,
			demand_signUp_num

		FROM
			student_demand sd
		LEFT JOIN
			teach_grade tg
		ON	
			sd.demand_grade = tg.teach_grade_id 
		LEFT JOIN
			teach_branch tb
		ON
			sd.subject_id = tb.teach_branch_id
		LEFT JOIN
			student_demand_connect sdc
		ON
			sd.sid = sdc.demand_id
		LEFT JOIN
			teacher t
		ON
			sdc.teacher_id = t.teacher_id
		AND
			sd.parameter_id like '%t.teach_address%'
		AND
			sd.subject_id like '%t.teach_brance%'
		AND
			sd.subject_id like '%t.teach_branch_slave%'
		AND
			sd.demand_grade like '%t.teach_grade%'
		AND
			t.`status` = 1
		WHERE
			sd.demand_type = 2
		AND
			sdc.order_teach_time is null
		AND
			sdc.teacher_id = #{teacherId}
    </select>
    
    <!-- 查询用户所有的订单 -->
    <select id="queryUserDemandsList" parameterType="java.util.Map" resultMap="studentDemandsResultMap">
    	SELECT
			sd.sid,
			s.student_name,
			tg.teach_grade_name,
			tb.teach_branch_name,
			date_format(sd.create_time, '%Y-%m-%d %T') as create_time,
			sd.order_money,
			sdc.order_teach_time,
			sdc.`status` as demandSignStatus
		FROM
			student_demand_connect sdc
		LEFT JOIN
			student_demand sd
		ON
			sdc.demand_id = sd.sid
		LEFT JOIN
			teach_grade tg
		ON
			sd.demand_grade = tg.teach_grade_id
		LEFT JOIN
			teach_branch tb
		ON
			sd.subject_id = tb.teach_branch_id
		LEFT JOIN
			student s
		ON
			sd.student_id = s.sid
		WHERE
			sdc.teacher_id = #{teacherId}
			
		<if test="list != null">
			AND sdc.status in 
			
			<foreach collection="list" item="item" index="index" open="(" close=")" separator=",">
		       #{item}
		   </foreach>
		   
     	</if>
     	
		ORDER BY
			sd.create_time desc
		<if test="offset != null">
            <![CDATA[
               limit #{pageSize} offset #{offset}
            ]]>
        </if>
    </select>
    
	<resultMap id="studentDemandsDetailResultMap" type="com.education.hjj.bz.entity.vo.StudentDemandVo" >
		<!-- column代表数据库列名，property代表实体类属性名 -->
		<result column="sid" property="sid"/>
		<result column="student_name" property="studentName"/>
		<result column="teacher_name" property="teachName"/>
		<result column="class_num" property="classNum"/>
		<result column="week_num" property="weekNum"/>
		<result column="time_range" property="timeRange"/>
		<result column="order_money" property="orderMoney"/>
		<result column="demand_desc" property="demandDesc"/>
		<result column="demand_address" property="demandAddress"/>
		<result column="create_time" property="createTime"/>
		<result column="sign_time" property="signTime"/>
		<result column="teach_grade_name" property="teachGradeName"/>
		<result column="teach_branch_name" property="teachBranchName"/>
		<result column="order_teach_time" property="orderTeachTime"/>
		<result column="order_start" property="orderStart"/>
		<result column="parent_phone_num" property="parentPhoneNum"/>
		<result column="demandSignStatus" property="demandSignStatus"/>
		<result column="status" property="status"/>
	</resultMap>
    
    <!-- 订单详情 -->
     <select id ="queryStudemtDemandDetail" parameterType="com.education.hjj.bz.formBean.StudentDemandConnectForm" resultMap="studentDemandsDetailResultMap">
    	SELECT
			sd.sid,
			s.student_name,
			tg.teach_grade_name,
			tb.teach_branch_name,
			date_format(sd.create_time, '%Y-%m-%d %T') as create_time,
			sd.order_money,
			sdc.order_teach_time,
			sd.order_start,
			date_format(sdc.create_time, '%Y-%m-%d %T') as sign_time,
			sd.demand_address,
			sd.time_range,
			sd.class_num,
			sd.week_num,
			sd.demand_desc,
			s.parent_phone_num,
			sdc.status as demandSignStatus
			
		FROM
			student_demand_connect sdc
		LEFT JOIN
			student_demand sd
		ON
			sdc.demand_id = sd.sid
		LEFT JOIN
			teach_grade tg
		ON
			sd.demand_grade = tg.teach_grade_id
		LEFT JOIN
			teach_branch tb
		ON
			sd.subject_id = tb.teach_branch_id
		LEFT JOIN
			student s
		ON
			sd.student_id = s.sid
		WHERE
			
			sd.sid = #{demandId}
		and
			sdc.status = #{status}
		ORDER BY
			sd.create_time desc
	
    </select>
    
    <!-- 教员接受学员订单,并更新报名表试讲时间和订单状态 -->
    <update id="updateNewTrialDemandTime" parameterType="com.education.hjj.bz.formBean.StudentDemandConnectForm">
    	UPDATE 
    		student_demand_connect
		SET 
			status = #{status},
			order_teach_time = #{orderTeachTime},
			update_time = #{updateTime}
			
		WHERE 
			demand_id = #{demandId}
		and
			teacher_id = #{teacherId}
    </update>
    
    <!-- 教员接受学员订单,并更新订单表订单状态 -->
    <update id="updateNewTrialDemandStatus" parameterType="com.education.hjj.bz.formBean.StudentDemandForm">
    	UPDATE 
    		student_demand
		SET 
			status = #{status},
			update_time = #{updateTime}
			
		WHERE sid = #{demandId}
    </update>
    
    <!-- 查询教员课程表 -->
    <select id="queryTimeTableByTeacherId" parameterType="com.education.hjj.bz.formBean.StudentDemandConnectForm" resultMap="studentDemandsDetailResultMap">
    	select 
			sd.sid,
			t.`name` as teacher_name,
			s.student_name,
			tb.teach_branch_name,
			sd.time_range,
			sdc.order_teach_time,
			sd.week_num,
			sdc.`status` as demandSignStatus,
			sd.status,
			sd.order_start
		FROM
			student_demand_connect sdc
		LEFT JOIN
			student_demand sd
		ON
			sdc.demand_id = sd.sid
		LEFT JOIN
			student s
		ON
			sd.student_id =s.sid
		LEFT JOIN
			teacher t
		ON
			sdc.teacher_id = t.teacher_id
		LEFT JOIN
			teach_branch tb
		ON
			sd.subject_id = tb.teach_branch_id
		WHERE
			sdc.`status` = 4 
		AND
			sdc.teacher_id = #{teacherId}
    </select>	
</mapper>